# This config was automatically generated from your source code
# Stacks detected: deps:python:.
version: 2.1
orbs:
  python: circleci/python@2
  discord: antonioned/discord@0.1.0
  checkov: bridgecrew/checkov@x.y.z

jobs:
  build:
    working_directory: ~/app
    docker:
      - image: cimg/base:2022.09
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker build -t $DOCKERHUB_USERNAME/weathertest:$TAG .
            docker tag $DOCKERHUB_USERNAME/weathertest:$TAG registry.gitlab.com/devops1771522/weathertest:$TAG
            docker build -t registry.gitlab.com/devops1771522/weather:$TAG .
#            docker build -t gitlab.com/devops1771522/weather/weathertest:$TAG .
      - run:
          name: Reachability Test
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker run -d -p80:5000 $DOCKERHUB_USERNAME/weathertest:$TAG
            sh test.sh
      - run:
          name: Push application Docker image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            echo "$TOKEN" | docker login registry.gitlab.com -u sbidarski --password-stdin
            docker push registry.gitlab.com/devops1771522/weather:$TAG

      - checkov/scan:
          directory: '~/app'
          soft-fail: true
          output: "junitxml"
          api-key: "6bridgecrew-9example-2api-key1-demo9"

#      - discord/status:
#          fail_only: false
#          failure_message: "**${CIRCLE_USERNAME}**'s build: **${CIRCLE_JOB}** failed."
#          success_message: "**${CIRCLE_USERNAME}** deployed api to prod."
#          webhook: "${DISCORD_STATUS_WEBHOOK}"
