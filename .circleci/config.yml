# This config was automatically generated from your source code
# Stacks detected: deps:python:.
version: 2.1
orbs:
  python: circleci/python@2

orbs:
  discord: antonioned/discord@0.1.0

jobs:
  build:
    working_directory: ~/app
    docker:
      - image: cimg/base:2022.09
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker build -t $DOCKERHUB_USERNAME/weathertest:$TAG .

      - run:
          name: Reachability Test
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker run -d -p80:5000 $DOCKERHUB_USERNAME/weathertest:$TAG
            sh test.sh
      - run:
          name: Push application Docker image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
            docker push $DOCKERHUB_USERNAME/weathertest:$TAG

jobs:
  build:
    working_directory: ~/app
    docker:
      - image: cimg/base:2024.05
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    discord/steps:
      - checkout

      - discord/status:
          fail_only: false
          failure_message: "**${CIRCLE_USERNAME}**'s build: **${CIRCLE_JOB}** failed."
          success_message: "**${CIRCLE_USERNAME}** deployed api to prod."
          webhook: https://discord.com/api/webhooks/1244983967401119865/P4IPNGFg3_4RQTTaWsw2V_jgHQCebrGeja3RbpC8ZFL3grxHF9pIt6q9A5QkgvRAfH2G
